<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈüìÂõΩ„Éâ„É©„Éû„ÉªÊò†Áîª„É≠„Ç±Âú∞„Ç¨„Ç§„Éâ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .back-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .filter-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s;
        }

        .filter-tab.active {
            color: #e91e63;
            border-bottom: 2px solid #e91e63;
            font-weight: bold;
        }

        .search-bar {
            padding: 15px;
            background: #fff;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 0.95rem;
            outline: none;
        }

        .search-bar input:focus {
            border-color: #e91e63;
        }

        .location-list {
            padding: 10px 15px;
        }

        .location-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .location-card:active {
            transform: scale(0.98);
        }

        .location-card .thumbnail-wrapper {
            position: relative;
            width: 100%;
            height: 180px;
        }

        .location-card .thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .location-card .actor-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px 5px 5px;
            border-radius: 20px;
            color: white;
            font-size: 0.75rem;
        }

        .location-card .actor-badge img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 6px;
            border: 2px solid #e91e63;
        }

        .location-card .title-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 10px 10px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
        }

        .location-card .title-overlay .drama-title {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .location-card .info {
            padding: 12px 15px;
        }

        .location-card .type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-bottom: 8px;
        }

        .type-badge.drama {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-badge.movie {
            background: #fce4ec;
            color: #c2185b;
        }

        .location-card .title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .location-card .location-name {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .location-card .actors {
            font-size: 0.8rem;
            color: #e91e63;
        }

        .detail-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 200;
            overflow-y: auto;
        }

        .detail-page.active {
            display: block;
        }

        .detail-hero {
            position: relative;
            height: 250px;
        }

        .detail-hero img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-hero .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
        }

        .detail-hero .title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .detail-hero .year {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .detail-content {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            font-size: 1rem;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e91e63;
            display: inline-block;
        }

        .detail-section p {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.6;
        }

        .actors-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .actor-item {
            text-align: center;
            flex-shrink: 0;
        }

        .actor-item img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e91e63;
            background: #f0f0f0;
        }

        .actor-item .name {
            font-size: 0.8rem;
            margin-top: 5px;
            color: #333;
        }

        .map-container {
            height: 250px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #detail-map {
            height: 100%;
            width: 100%;
        }

        .direction-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .direction-btn:active {
            opacity: 0.9;
        }

        .photo-section {
            background: linear-gradient(135deg, #fff5f8 0%, #f8f0ff 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .photo-section h3 {
            color: #e91e63;
            margin-bottom: 15px;
        }

        .scene-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #000;
        }

        .photo-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
        }

        .photo-btn:active {
            opacity: 0.9;
        }

        #photo-input {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 12px;
        }

        .modal .actions {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        .modal button {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .modal .download-btn {
            background: #4CAF50;
            color: white;
        }

        .modal .close-btn {
            background: #666;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 3px solid #eee;
            border-top-color: #e91e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .placeholder-img {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 2rem;
        }

        .address-info {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .address-info .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 3px;
        }

        .address-info .value {
            font-size: 0.95rem;
            color: #333;
        }

        .distance-info {
            text-align: center;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header" id="main-header">
            <h1>ÈüìÂõΩ„É≠„Ç±Âú∞„Ç¨„Ç§„Éâ</h1>
            <p>„Éâ„É©„Éû„ÉªÊò†Áîª„ÅÆÊíÆÂΩ±„Çπ„Éù„ÉÉ„Éà„ÇíÊé¢„Åù„ÅÜ</p>
        </header>

        <div class="filter-tabs">
            <button class="filter-tab active" data-type="all">„Åô„Åπ„Å¶</button>
            <button class="filter-tab" data-type="drama">„Éâ„É©„Éû</button>
            <button class="filter-tab" data-type="movie">Êò†Áîª</button>
        </div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="‰ΩúÂìÅÂêç„ÄÅ„É≠„Ç±Âú∞Âêç„ÅßÊ§úÁ¥¢...">
        </div>

        <div class="location-list" id="location-list">
            <div class="loading">„É≠„Ç±Âú∞ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
    </div>

    <div class="detail-page" id="detail-page">
        <header class="header" style="position: relative;">
            <button class="back-btn" onclick="closeDetail()">‚Üê Êàª„Çã</button>
            <h1 id="detail-title">„É≠„Ç±Âú∞Ë©≥Á¥∞</h1>
        </header>

        <div class="detail-hero">
            <img id="detail-scene-img" src="" alt="Scene">
            <div class="overlay">
                <div class="title" id="detail-hero-title"></div>
                <div class="year" id="detail-hero-year"></div>
            </div>
        </div>

        <div class="detail-content">
            <div class="detail-section">
                <h3>„Ç∑„Éº„É≥Ë™¨Êòé</h3>
                <p id="detail-description"></p>
            </div>

            <div class="detail-section" id="actors-section">
                <h3>Âá∫Êºî‰ø≥ÂÑ™</h3>
                <div class="actors-grid" id="actors-grid"></div>
            </div>

            <div class="detail-section">
                <h3>„É≠„Ç±Âú∞ÊÉÖÂ†±</h3>
                <div class="address-info">
                    <div class="label">Â†¥ÊâÄÂêç</div>
                    <div class="value" id="detail-location-name"></div>
                </div>
                <div class="address-info">
                    <div class="label">‰ΩèÊâÄ</div>
                    <div class="value" id="detail-address"></div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Âú∞Âõ≥</h3>
                <div id="distance-info" class="distance-info" style="display:none;"></div>
                <div class="map-container">
                    <div id="detail-map"></div>
                </div>
                <button class="direction-btn" id="direction-btn" onclick="openNavigation()">
                    „É´„Éº„ÉàÊ°àÂÜÖ
                </button>
            </div>

            <div class="detail-section">
                <div class="photo-section">
                    <h3>Ë®òÂøµÂÜôÁúü„ÇíÊíÆ„Çç„ÅÜÔºÅ</h3>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                        „ÅÇ„Å™„Åü„ÅÆÂÜôÁúü„Çí„Éâ„É©„Éû„ÅÆ„Ç∑„Éº„É≥„Å´ÂêàÊàê„Åß„Åç„Åæ„Åô
                    </p>
                    <img id="scene-preview" class="scene-preview" src="" alt="Scene">
                    <br><br>
                    <button class="photo-btn" onclick="document.getElementById('photo-input').click()">
                        ÂÜôÁúü„ÇíÈÅ∏Êäû
                    </button>
                    <input type="file" id="photo-input" accept="image/*" capture="environment" onchange="uploadPhoto(this)">
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="result-modal">
        <img id="result-image" src="" alt="Composite Result">
        <div class="actions">
            <button class="download-btn" onclick="downloadImage()">‰øùÂ≠ò</button>
            <button class="close-btn" onclick="closeModal()">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <script>
        let locations = [];
        let currentLocation = null;
        let detailMap = null;
        let userPosition = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadLocations();
            getCurrentPosition();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterLocations();
                });
            });

            document.getElementById('search-input').addEventListener('input', debounce(filterLocations, 300));
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function getCurrentPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                    },
                    (error) => {
                        console.log('Location error:', error);
                    }
                );
            }
        }

        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                locations = await response.json();
                renderLocations(locations);
            } catch (error) {
                console.error('Error loading locations:', error);
                document.getElementById('location-list').innerHTML =
                    '<div class="loading">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
            }
        }

        function filterLocations() {
            const type = document.querySelector('.filter-tab.active').dataset.type;
            const keyword = document.getElementById('search-input').value.toLowerCase();

            let filtered = locations;

            if (type !== 'all') {
                filtered = filtered.filter(loc => loc.type === type);
            }

            if (keyword) {
                filtered = filtered.filter(loc =>
                    loc.title_ja.toLowerCase().includes(keyword) ||
                    loc.location_name_ja.toLowerCase().includes(keyword) ||
                    (loc.actors_ja && loc.actors_ja.toLowerCase().includes(keyword))
                );
            }

            renderLocations(filtered);
        }

        function renderLocations(data) {
            const container = document.getElementById('location-list');

            if (data.length === 0) {
                container.innerHTML = '<div class="loading" style="padding:30px;">Ë©≤ÂΩì„Åô„Çã„É≠„Ç±Âú∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            container.innerHTML = data.map(loc => `
                <div class="location-card" onclick="showDetail(${loc.id})">
                    <div class="thumbnail-wrapper">
                        <img class="thumbnail" src="${loc.scene_image || loc.thumbnail || ''}" alt="${loc.title_ja}"
                             onerror="this.className='thumbnail placeholder-img'; this.outerHTML='<div class=\\'thumbnail placeholder-img\\'>üé¨</div>';">
                        ${loc.main_actor_photo ? `
                        <div class="actor-badge">
                            <img src="${loc.main_actor_photo}" alt="${loc.main_actor_name || ''}"
                                 onerror="this.style.display='none'">
                            <span>${loc.main_actor_name || ''}</span>
                        </div>` : ''}
                    </div>
                    <div class="info">
                        <span class="type-badge ${loc.type}">${loc.type === 'drama' ? '„Éâ„É©„Éû' : 'Êò†Áîª'}</span>
                        <div class="title">${loc.title_ja}</div>
                        <div class="location-name">üìç ${loc.location_name_ja}</div>
                        ${loc.actors_ja ? `<div class="actors">‚≠ê ${loc.actors_ja}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function showDetail(id) {
            try {
                const response = await fetch(`/api/locations/${id}`);
                currentLocation = await response.json();

                document.getElementById('detail-title').textContent = currentLocation.title_ja;
                document.getElementById('detail-hero-title').textContent = currentLocation.title_ja;
                document.getElementById('detail-hero-year').textContent = `${currentLocation.year}Âπ¥ | ${currentLocation.type === 'drama' ? '„Éâ„É©„Éû' : 'Êò†Áîª'}`;
                document.getElementById('detail-description').textContent = currentLocation.description_ja;
                document.getElementById('detail-location-name').textContent = currentLocation.location_name_ja;
                document.getElementById('detail-address').textContent = currentLocation.address_ja;

                const sceneImg = document.getElementById('detail-scene-img');
                sceneImg.onerror = function() {
                    this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="250"><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="48">üé¨</text></svg>';
                };
                sceneImg.src = currentLocation.scene_image || '';

                const scenePreview = document.getElementById('scene-preview');
                scenePreview.onerror = sceneImg.onerror;
                scenePreview.src = currentLocation.scene_image || '';

                const actorsSection = document.getElementById('actors-section');
                const actorsGrid = document.getElementById('actors-grid');
                if (currentLocation.actors && currentLocation.actors.length > 0) {
                    actorsSection.style.display = 'block';
                    actorsGrid.innerHTML = currentLocation.actors.map(actor => `
                        <div class="actor-item">
                            <img src="${actor.photo || ''}" alt="${actor.name_ja}"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2270%22 height=%2270%22><circle cx=%2235%22 cy=%2235%22 r=%2235%22 fill=%22%23e91e63%22/><text x=%2250%%22 y=%2255%%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2224%22>‚≠ê</text></svg>'">
                            <div class="name">${actor.name_ja}</div>
                        </div>
                    `).join('');
                } else {
                    actorsSection.style.display = 'none';
                }

                if (userPosition) {
                    const distance = calculateDistance(
                        userPosition.lat, userPosition.lng,
                        currentLocation.latitude, currentLocation.longitude
                    );
                    document.getElementById('distance-info').style.display = 'block';
                    document.getElementById('distance-info').textContent =
                        `üìç ÁèæÂú®Âú∞„Åã„ÇâÁ¥Ñ ${distance.toFixed(1)} km`;
                }

                setTimeout(() => {
                    initDetailMap();
                }, 100);

                document.getElementById('detail-page').classList.add('active');
                document.getElementById('detail-page').scrollTop = 0;

            } catch (error) {
                console.error('Error loading detail:', error);
                alert('Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function initDetailMap() {
            if (detailMap) {
                detailMap.remove();
            }

            const lat = currentLocation.latitude;
            const lng = currentLocation.longitude;

            detailMap = L.map('detail-map').setView([lat, lng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(detailMap);

            L.marker([lat, lng])
                .addTo(detailMap)
                .bindPopup(`<b>${currentLocation.title_ja}</b><br>${currentLocation.location_name_ja}`)
                .openPopup();

            if (userPosition) {
                L.marker([userPosition.lat, userPosition.lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background:#4CAF50;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(detailMap).bindPopup('ÁèæÂú®Âú∞');

                const bounds = L.latLngBounds([
                    [lat, lng],
                    [userPosition.lat, userPosition.lng]
                ]);
                detailMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function openNavigation() {
            if (!currentLocation) return;

            const destLat = currentLocation.latitude;
            const destLng = currentLocation.longitude;

            // Google MapsÊó•Êú¨Ë™ûË°®Á§∫Ôºà„ÇØ„É©„Ç∑„ÉÉ„ÇØURLÂΩ¢ÂºèÔºâ
            const url = `https://maps.google.co.jp/maps?q=${destLat},${destLng}&hl=ja&gl=jp`;

            window.open(url, '_blank');
        }

        function closeDetail() {
            document.getElementById('detail-page').classList.remove('active');
            currentLocation = null;
        }

        async function uploadPhoto(input) {
            if (!input.files || !input.files[0]) return;
            if (!currentLocation) {
                alert('„É≠„Ç±Âú∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const btn = document.querySelector('.photo-btn');
            btn.textContent = 'ÂêàÊàê‰∏≠...';
            btn.disabled = true;

            try {
                const userFile = input.files[0];
                const compositeDataUrl = await compositeImages(userFile);

                if (compositeDataUrl) {
                    document.getElementById('result-image').src = compositeDataUrl;
                    document.getElementById('result-modal').classList.add('active');
                }

                btn.innerHTML = 'ÂÜôÁúü„ÇíÈÅ∏Êäû';
                btn.disabled = false;
                input.value = '';

            } catch (error) {
                console.error('Composite error:', error);
                alert('ÂÜôÁúüÂêàÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                btn.innerHTML = 'ÂÜôÁúü„ÇíÈÅ∏Êäû';
                btn.disabled = false;
            }
        }

        async function compositeImages(userFile) {
            return new Promise((resolve, reject) => {
                const sceneImg = new Image();
                sceneImg.crossOrigin = 'anonymous';

                sceneImg.onload = () => {
                    const userImg = new Image();
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        userImg.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            canvas.width = sceneImg.width || 800;
                            canvas.height = sceneImg.height || 450;

                            ctx.drawImage(sceneImg, 0, 0, canvas.width, canvas.height);

                            const userSize = Math.min(canvas.width, canvas.height) * 0.35;
                            const userX = canvas.width - userSize - 20;
                            const userY = canvas.height - userSize - 20;

                            ctx.save();
                            ctx.beginPath();
                            ctx.arc(userX + userSize/2, userY + userSize/2, userSize/2, 0, Math.PI * 2);
                            ctx.closePath();
                            ctx.clip();

                            const minDim = Math.min(userImg.width, userImg.height);
                            const sx = (userImg.width - minDim) / 2;
                            const sy = (userImg.height - minDim) / 2;
                            ctx.drawImage(userImg, sx, sy, minDim, minDim, userX, userY, userSize, userSize);

                            ctx.restore();

                            ctx.beginPath();
                            ctx.arc(userX + userSize/2, userY + userSize/2, userSize/2, 0, Math.PI * 2);
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 4;
                            ctx.stroke();

                            ctx.fillStyle = 'rgba(0,0,0,0.5)';
                            ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
                            ctx.fillStyle = '#ffffff';
                            ctx.font = 'bold 16px sans-serif';
                            ctx.fillText(`üìç ${currentLocation.title_ja} - ${currentLocation.location_name_ja}`, 10, canvas.height - 15);

                            resolve(canvas.toDataURL('image/jpeg', 0.9));
                        };

                        userImg.onerror = () => reject(new Error('Failed to load user image'));
                        userImg.src = e.target.result;
                    };

                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsDataURL(userFile);
                };

                sceneImg.onerror = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 800;
                    canvas.height = 450;

                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    gradient.addColorStop(0, '#667eea');
                    gradient.addColorStop(1, '#764ba2');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 32px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(currentLocation.title_ja, canvas.width/2, canvas.height/2 - 50);
                    ctx.font = '20px sans-serif';
                    ctx.fillText(currentLocation.location_name_ja, canvas.width/2, canvas.height/2);

                    const userImg = new Image();
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        userImg.onload = () => {
                            const userSize = 150;
                            const userX = canvas.width - userSize - 30;
                            const userY = canvas.height - userSize - 60;

                            ctx.save();
                            ctx.beginPath();
                            ctx.arc(userX + userSize/2, userY + userSize/2, userSize/2, 0, Math.PI * 2);
                            ctx.closePath();
                            ctx.clip();

                            const minDim = Math.min(userImg.width, userImg.height);
                            const sx = (userImg.width - minDim) / 2;
                            const sy = (userImg.height - minDim) / 2;
                            ctx.drawImage(userImg, sx, sy, minDim, minDim, userX, userY, userSize, userSize);

                            ctx.restore();

                            ctx.beginPath();
                            ctx.arc(userX + userSize/2, userY + userSize/2, userSize/2, 0, Math.PI * 2);
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 4;
                            ctx.stroke();

                            resolve(canvas.toDataURL('image/jpeg', 0.9));
                        };
                        userImg.src = e.target.result;
                    };
                    reader.readAsDataURL(userFile);
                };

                const sceneUrl = currentLocation.scene_image || '';
                if (sceneUrl) {
                    sceneImg.src = sceneUrl;
                } else {
                    sceneImg.onerror();
                }
            });
        }

        function downloadImage() {
            const img = document.getElementById('result-image');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = 'korea_location_photo.jpg';
            link.click();
        }

        function closeModal() {
            document.getElementById('result-modal').classList.remove('active');
        }
    </script>
</body>
</html>
