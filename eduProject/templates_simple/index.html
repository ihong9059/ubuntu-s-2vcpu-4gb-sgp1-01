<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ í•™ìŠµ ìŠ¤íƒ€ì¼ì€? - Sam English</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif; }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.2), transparent),
                radial-gradient(2px 2px at 50px 160px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 90px 40px, rgba(255,255,255,0.2), transparent);
            background-repeat: repeat;
            background-size: 200px 200px;
            animation: twinkle 5s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .main-container { max-width: 600px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }

        .logo-header { text-align: center; padding: 15px 0; margin-bottom: 10px; }
        .logo-header img { height: 60px; background: white; padding: 8px 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .logo-header img:hover { transform: scale(1.05); }

        .card {
            border: none; border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
            backdrop-filter: blur(10px);
            overflow: hidden;
            position: relative;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c); }
        .card-body { padding: 35px; }

        .start-screen h1 {
            font-size: 2.2rem; font-weight: 900;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        .feature-badges { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        .feature-badge { background: linear-gradient(135deg, #667eea20, #764ba220); border: 1px solid #667eea40; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; color: #667eea; font-weight: 600; }

        .progress { height: 10px; border-radius: 10px; background: #e9ecef; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, #667eea, #764ba2, #f093fb); border-radius: 10px; transition: width 0.5s; position: relative; }
        .progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .question-counter { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .area-badge { background: #f8f9ff; border: 2px solid #667eea; color: #667eea; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }

        .question-container { background: linear-gradient(135deg, #f8f9ff 0%, #fff5f5 100%); border-radius: 20px; padding: 30px; margin: 25px 0; position: relative; }
        .question-container::before { content: '"'; position: absolute; top: 10px; left: 20px; font-size: 4rem; color: #667eea20; font-family: Georgia, serif; }
        .question-text { font-size: 1.35rem; font-weight: 700; line-height: 1.6; color: #333; }
        .question-emoji { font-size: 3.5rem; margin-bottom: 15px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1)); }

        .choice-btn {
            display: flex; align-items: center; width: 100%; padding: 18px 24px; margin: 12px 0;
            border: 2px solid #e9ecef; border-radius: 16px; background: #fff;
            text-align: left; font-size: 1.05rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .choice-btn::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: linear-gradient(180deg, #667eea, #764ba2); opacity: 0; transition: opacity 0.3s; }
        .choice-btn:hover { border-color: #667eea; background: #f8f9ff; transform: translateX(8px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2); }
        .choice-btn:hover::before { opacity: 1; }
        .choice-btn.selected { border-color: transparent; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; transform: translateX(8px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .choice-icon { width: 28px; height: 28px; border: 2px solid #ddd; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .choice-btn:hover .choice-icon { border-color: #667eea; }
        .choice-btn.selected .choice-icon { border-color: white; background: white; }
        .choice-btn.selected .choice-icon::after { content: 'âœ“'; color: #667eea; font-weight: bold; }

        .result-header { background: linear-gradient(135deg, #667eea, #764ba2); margin: -35px -35px 30px -35px; padding: 40px 35px; text-align: center; color: white; position: relative; overflow: hidden; }
        .result-header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: pulse 3s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }

        .result-emoji { font-size: 5rem; filter: drop-shadow(0 4px 15px rgba(0,0,0,0.2)); animation: bounce 2s ease-in-out infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .result-type { font-size: 2rem; font-weight: 900; margin: 15px 0 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .score-badge { display: inline-block; padding: 12px 30px; border-radius: 30px; font-weight: 800; font-size: 1.8rem; background: white; color: #667eea; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }

        .area-item { padding: 16px 0; border-bottom: 1px solid #eee; }
        .area-item:last-child { border-bottom: none; }
        .area-name { font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .area-bar { height: 12px; border-radius: 6px; background: #e9ecef; margin-top: 8px; overflow: hidden; }
        .area-fill { height: 100%; border-radius: 6px; transition: width 1.5s; position: relative; }

        .advice-box { background: linear-gradient(135deg, #fff9e6 0%, #fff5f5 100%); border: none; border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
        .advice-box::before { content: 'ğŸ’¡'; position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.15; }

        .btn-gradient { background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; font-weight: 700; padding: 16px 32px; border-radius: 16px; transition: all 0.3s; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); }
        .btn-gradient:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4); color: white; }

        .btn-outline-gradient { background: white; border: 2px solid #667eea; color: #667eea; font-weight: 600; padding: 14px 28px; border-radius: 16px; transition: all 0.3s; }
        .btn-outline-gradient:hover { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; color: white; }

        .hidden { display: none !important; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeInUp 0.5s ease-out; }

        .form-control-custom { border: 2px solid #e9ecef; border-radius: 16px; padding: 16px 20px; font-size: 1.1rem; transition: all 0.3s; }
        .form-control-custom:focus { border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }

        .analysis-content { font-size: 0.95rem; line-height: 1.8; color: #333; }
        .analysis-content h1 { font-size: 1.5rem; color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; margin: 25px 0 15px 0; }
        .analysis-content h2 { font-size: 1.25rem; color: #764ba2; margin: 20px 0 12px 0; padding-left: 10px; border-left: 4px solid #764ba2; }
        .analysis-content strong { color: #667eea; }
        .analysis-content blockquote { background: linear-gradient(135deg, #f8f9ff 0%, #fff5f5 100%); border-left: 4px solid #667eea; padding: 15px 20px; margin: 15px 0; border-radius: 0 12px 12px 0; }

        @media (max-width: 576px) {
            .question-text { font-size: 1.15rem; }
            .choice-btn { padding: 14px 18px; font-size: 0.95rem; }
            .result-type { font-size: 1.6rem; }
            .card-body { padding: 25px; }
            .result-header { margin: -25px -25px 25px -25px; padding: 30px 25px; }
        }
    </style>
</head>
<body>
    <div class="main-container py-3">
        <div class="logo-header">
            <img src="/static/images/sam_english_logo.svg" alt="Sam English">
        </div>

        <div id="startScreen" class="card fade-in">
            <div class="card-body text-center">
                <h1 class="mb-3">ë‚˜ì˜ í•™ìŠµ ìŠ¤íƒ€ì¼ì€?</h1>
                <p class="text-muted mb-3">25ê°œ ì§ˆë¬¸ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ë§Œì˜ í•™ìŠµ íŒ¨í„´</p>

                <div class="feature-badges">
                    <span class="feature-badge"><i class="bi bi-clock"></i> ì•½ 5ë¶„</span>
                    <span class="feature-badge"><i class="bi bi-graph-up"></i> 5ê°œ ì˜ì—­</span>
                    <span class="feature-badge"><i class="bi bi-robot"></i> AI ë¶„ì„</span>
                </div>

                <div class="mb-3">
                    <input type="text" id="userName" class="form-control form-control-custom text-center" placeholder="ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„">
                </div>
                <div class="mb-4">
                    <select id="userGrade" class="form-select form-control-custom text-center">
                        <option value="">í•™ë…„ ì„ íƒ</option>
                        <option value="ì¤‘1">ì¤‘í•™êµ 1í•™ë…„</option>
                        <option value="ì¤‘2">ì¤‘í•™êµ 2í•™ë…„</option>
                        <option value="ì¤‘3">ì¤‘í•™êµ 3í•™ë…„</option>
                        <option value="ê³ 1">ê³ ë“±í•™êµ 1í•™ë…„</option>
                        <option value="ê³ 2">ê³ ë“±í•™êµ 2í•™ë…„</option>
                        <option value="ê³ 3">ê³ ë“±í•™êµ 3í•™ë…„</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>

                <button class="btn btn-gradient btn-lg w-100" onclick="startTest()">
                    <i class="bi bi-play-fill"></i> í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°
                </button>

                <div class="mt-4">
                    <small class="text-muted"><i class="bi bi-shield-check"></i> ê°œì¸ì •ë³´ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</small>
                </div>
            </div>
        </div>

        <div id="testScreen" class="card hidden">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="question-counter" id="questionNum"><i class="bi bi-question-circle"></i> 1 / 25</span>
                    <span class="area-badge" id="areaName">ê³„íšë ¥</span>
                </div>
                <div class="progress mb-4">
                    <div class="progress-bar" id="progressBar" style="width: 4%"></div>
                </div>

                <div class="question-container text-center">
                    <div class="question-emoji" id="questionEmoji">ğŸ“‹</div>
                    <div class="question-text" id="questionText">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>

                <div id="choices">
                    <button class="choice-btn" onclick="selectAnswer(4)"><span class="choice-icon"></span>ë§¤ìš° ê·¸ë ‡ë‹¤</button>
                    <button class="choice-btn" onclick="selectAnswer(3)"><span class="choice-icon"></span>ê·¸ëŸ° í¸ì´ë‹¤</button>
                    <button class="choice-btn" onclick="selectAnswer(2)"><span class="choice-icon"></span>ì•„ë‹Œ í¸ì´ë‹¤</button>
                    <button class="choice-btn" onclick="selectAnswer(1)"><span class="choice-icon"></span>ì „í˜€ ì•„ë‹ˆë‹¤</button>
                </div>
            </div>
        </div>

        <div id="resultScreen" class="card hidden">
            <div class="card-body" style="padding: 0;">
                <div class="result-header">
                    <div class="result-emoji" id="resultEmoji">ğŸŒŸ</div>
                    <div class="result-type" id="resultType">ë¶„ì„ì¤‘...</div>
                    <p class="mb-3 opacity-75" id="resultDesc">ì„¤ëª…</p>
                    <span class="score-badge" id="totalScoreBadge">0ì </span>
                </div>

                <div style="padding: 0 35px 35px 35px;">
                    <div style="height: 280px; margin: 20px 0;"><canvas id="radarChart"></canvas></div>

                    <div class="mt-4">
                        <h6 class="mb-3 fw-bold"><i class="bi bi-bar-chart-fill text-primary"></i> ì˜ì—­ë³„ ìƒì„¸ ì ìˆ˜</h6>
                        <div id="areaScores"></div>
                    </div>

                    <div class="advice-box mt-4">
                        <strong><i class="bi bi-lightbulb-fill text-warning"></i> ë§ì¶¤ ì¡°ì–¸</strong>
                        <p class="mb-0 mt-2" id="adviceText"></p>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-gradient btn-lg" id="analyzeBtn" onclick="analyzeWithAI()"><i class="bi bi-robot"></i> AIì—ê²Œ ìì„¸í•œ ë¶„ì„ ë°›ê¸°</button>
                        <button class="btn btn-outline-gradient" onclick="showAIPrompt()"><i class="bi bi-file-text"></i> í”„ë¡¬í”„íŠ¸ ë³´ê¸°</button>
                        <button class="btn btn-outline-gradient" onclick="restartTest()"><i class="bi bi-arrow-clockwise"></i> ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°</button>
                    </div>

                    <div id="loadingBox" class="mt-4 hidden text-center">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                        <p class="text-primary mt-3 fw-bold">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        <p class="text-muted small">ì•½ 1~2ë¶„ ì†Œìš”ë©ë‹ˆë‹¤</p>
                    </div>

                    <div id="analysisResultBox" class="mt-4 hidden">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="badge bg-success p-2"><i class="bi bi-check-circle"></i> AI ë¶„ì„ ì™„ë£Œ</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyAnalysis()"><i class="bi bi-clipboard"></i> ë³µì‚¬</button>
                        </div>
                        <div id="analysisResult" class="analysis-content border rounded-4 p-4 bg-white shadow-sm" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>

                    <div id="errorBox" class="mt-4 hidden">
                        <div class="alert alert-danger rounded-4" id="errorMessage"></div>
                    </div>

                    <div id="aiPromptBox" class="mt-4 hidden">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>AI ë¶„ì„ í”„ë¡¬í”„íŠ¸</strong>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyPrompt()"><i class="bi bi-clipboard"></i> ë³µì‚¬</button>
                        </div>
                        <textarea id="aiPrompt" class="form-control" rows="8" readonly style="font-size: 0.85rem; border-radius: 12px;"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <small class="text-white-50">Â© 2024 Sam English. All rights reserved.</small>
        </div>
    </div>

    <script>
        // ========== ì•Œë¦¼ìŒ ì‹œìŠ¤í…œ (ê°œì„  ë²„ì „) ==========
        let audioCtx = null;
        let soundEnabled = true;

        // AudioContext ì´ˆê¸°í™” (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ í˜¸ì¶œ)
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                console.log('AudioContext ì´ˆê¸°í™”ë¨');
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log('AudioContext resumed');
                });
            }
            return audioCtx;
        }

        // ë¹„í”„ìŒ ìƒì„± í•¨ìˆ˜ (ë³¼ë¥¨ ìµœëŒ€)
        function playBeep(frequency, duration, type = 'sine') {
            try {
                const ctx = initAudio();
                if (!ctx) return;

                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;

                // ë³¼ë¥¨ì„ ìµœëŒ€ë¡œ ì„¤ì • (1.0)
                gainNode.gain.setValueAtTime(1.0, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);

                console.log(`ë¹„í”„ìŒ ì¬ìƒ: ${frequency}Hz, ${duration}ì´ˆ`);
            } catch (e) {
                console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', e);
            }
        }

        // ë‹¤ìŒ ì§ˆë¬¸ ì•Œë¦¼ìŒ - ë°ì€ ëµ ì†Œë¦¬
        function playNextSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                if (!ctx) return;

                // ë‘ ìŒì„ ì—°ì†ìœ¼ë¡œ ì¬ìƒ (ëµë™)
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const gain1 = ctx.createGain();
                const gain2 = ctx.createGain();

                osc1.connect(gain1);
                gain1.connect(ctx.destination);
                osc2.connect(gain2);
                gain2.connect(ctx.destination);

                osc1.frequency.value = 880; // A5
                osc2.frequency.value = 1108.73; // C#6

                osc1.type = 'sine';
                osc2.type = 'sine';

                gain1.gain.setValueAtTime(0.8, ctx.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);

                gain2.gain.setValueAtTime(0.8, ctx.currentTime + 0.08);
                gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);

                osc1.start(ctx.currentTime);
                osc1.stop(ctx.currentTime + 0.15);
                osc2.start(ctx.currentTime + 0.08);
                osc2.stop(ctx.currentTime + 0.25);

                console.log('ë‹¤ìŒ ì§ˆë¬¸ ì•Œë¦¼ìŒ ì¬ìƒ');
            } catch (e) {
                console.error('playNextSound ì˜¤ë¥˜:', e);
            }
        }

        // ì‹œì‘ ì•Œë¦¼ìŒ - ìƒìŠ¹ ì•„ë¥´í˜ì§€ì˜¤
        function playStartSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                if (!ctx) return;

                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                const delay = 0.12;

                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.frequency.value = freq;
                    osc.type = 'sine';

                    const startTime = ctx.currentTime + i * delay;
                    gain.gain.setValueAtTime(0.7, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);

                    osc.start(startTime);
                    osc.stop(startTime + 0.3);
                });

                console.log('ì‹œì‘ ì•Œë¦¼ìŒ ì¬ìƒ');
            } catch (e) {
                console.error('playStartSound ì˜¤ë¥˜:', e);
            }
        }

        // ì™„ë£Œ ì•Œë¦¼ìŒ - ìŠ¹ë¦¬ íŒ¡íŒŒë ˆ
        function playCompleteSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                if (!ctx) return;

                const melody = [
                    { freq: 523.25, time: 0, dur: 0.2 },
                    { freq: 659.25, time: 0.15, dur: 0.2 },
                    { freq: 783.99, time: 0.3, dur: 0.2 },
                    { freq: 1046.50, time: 0.45, dur: 0.4 }
                ];

                melody.forEach(note => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.frequency.value = note.freq;
                    osc.type = 'sine';

                    const startTime = ctx.currentTime + note.time;
                    gain.gain.setValueAtTime(0.8, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + note.dur);

                    osc.start(startTime);
                    osc.stop(startTime + note.dur);
                });

                console.log('ì™„ë£Œ ì•Œë¦¼ìŒ ì¬ìƒ');
            } catch (e) {
                console.error('playCompleteSound ì˜¤ë¥˜:', e);
            }
        }

        // ì—ëŸ¬ ì•Œë¦¼ìŒ - ë‚®ì€ ë²„ì €ìŒ
        function playErrorSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                if (!ctx) return;

                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.3);
                osc.type = 'sawtooth';

                gain.gain.setValueAtTime(0.6, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);

                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.4);

                console.log('ì—ëŸ¬ ì•Œë¦¼ìŒ ì¬ìƒ');
            } catch (e) {
                console.error('playErrorSound ì˜¤ë¥˜:', e);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« í´ë¦­ìœ¼ë¡œ ì˜¤ë””ì˜¤ í™œì„±í™”
        document.addEventListener('click', function initOnFirstClick() {
            initAudio();
            document.removeEventListener('click', initOnFirstClick);
        }, { once: true });

        // ========== ì§ˆë¬¸ ë°ì´í„° ==========
        const questions = [
            { area: 'planning', emoji: 'ğŸ“‹', text: 'ë‚˜ëŠ” ê³µë¶€í•˜ê¸° ì „ì— ë­˜ í• ì§€ ë¯¸ë¦¬ ìƒê°í•´ë‘ëŠ” í¸ì´ë‹¤' },
            { area: 'planning', emoji: 'ğŸ“…', text: 'ì‹œí—˜ ê¸°ê°„ì— ê³„íší‘œë¥¼ ë§Œë“¤ì–´ ë³¸ ì ì´ ìˆë‹¤' },
            { area: 'planning', emoji: 'ğŸ¯', text: 'ì˜¤ëŠ˜ í•  ì¼ì„ ì•„ì¹¨ì— ëŒ€ì¶©ì´ë¼ë„ ì •í•´ë‘ëŠ” í¸ì´ë‹¤' },
            { area: 'planning', emoji: 'â°', text: 'ì•½ì† ì‹œê°„ì— ëŠ¦ì§€ ì•Šìœ¼ë ¤ê³  ë¯¸ë¦¬ ì¤€ë¹„í•˜ëŠ” í¸ì´ë‹¤' },
            { area: 'planning', emoji: 'ğŸ“', text: 'í•´ì•¼ í•  ì¼ì´ ë§ìœ¼ë©´ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•œë‹¤' },
            { area: 'focus', emoji: 'ğŸ§˜', text: 'ê³µë¶€í•  ë•Œ 30ë¶„ ì´ìƒ ì§‘ì¤‘í•  ìˆ˜ ìˆë‹¤' },
            { area: 'focus', emoji: 'ğŸ“µ', text: 'ê³µë¶€ ì¤‘ì— ìŠ¤ë§ˆíŠ¸í° ì•Œë¦¼ì´ ì™€ë„ ë°”ë¡œ í™•ì¸í•˜ì§€ ì•ŠëŠ”ë‹¤' },
            { area: 'focus', emoji: 'ğŸ§', text: 'ì£¼ë³€ì´ ì‹œë„ëŸ¬ì›Œë„ ì–´ëŠ ì •ë„ ì§‘ì¤‘í•  ìˆ˜ ìˆë‹¤' },
            { area: 'focus', emoji: 'ğŸ’­', text: 'ê³µë¶€ ì¤‘ì— ë”´ìƒê°ì´ ì˜ ì•ˆ ë‚˜ëŠ” í¸ì´ë‹¤' },
            { area: 'focus', emoji: 'ğŸ“š', text: 'í•œ ê³¼ëª©ì„ ëë‚´ê³  ë‹¤ë¥¸ ê³¼ëª©ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” í¸ì´ë‹¤' },
            { area: 'execution', emoji: 'ğŸš€', text: 'í•´ì•¼ í•  ì¼ì´ ìˆìœ¼ë©´ ë¯¸ë£¨ì§€ ì•Šê³  ë°”ë¡œ ì‹œì‘í•œë‹¤' },
            { area: 'execution', emoji: 'âœ…', text: 'ê³„íšì„ ì„¸ìš°ë©´ ì‹¤ì œë¡œ ì‹¤ì²œí•˜ëŠ” í¸ì´ë‹¤' },
            { area: 'execution', emoji: 'ğŸ’ª', text: 'ê·€ì°®ì•„ë„ í•´ì•¼ í•  ê±´ ì¼ë‹¨ í•œë‹¤' },
            { area: 'execution', emoji: 'ğŸƒ', text: 'ì•„ì¹¨ì— ì•ŒëŒ ìš¸ë¦¬ë©´ ë°”ë¡œ ì¼ì–´ë‚˜ëŠ” í¸ì´ë‹¤' },
            { area: 'execution', emoji: 'ğŸ“–', text: 'ìˆ™ì œëŠ” ë§ˆê° ì „ì— ë¯¸ë¦¬ ëë‚´ëŠ” í¸ì´ë‹¤' },
            { area: 'persistence', emoji: 'ğŸ”¥', text: 'ì–´ë ¤ìš´ ë¬¸ì œë„ í¬ê¸°í•˜ì§€ ì•Šê³  ëê¹Œì§€ í’€ì–´ë³¸ë‹¤' },
            { area: 'persistence', emoji: 'ğŸ”ï¸', text: 'ëª©í‘œë¥¼ ì •í•˜ë©´ ì‰½ê²Œ í¬ê¸°í•˜ì§€ ì•ŠëŠ”ë‹¤' },
            { area: 'persistence', emoji: 'ğŸ˜¤', text: 'ì•ˆ ë˜ëŠ” ê²Œ ìˆìœ¼ë©´ ë  ë•Œê¹Œì§€ í•´ë³´ëŠ” í¸ì´ë‹¤' },
            { area: 'persistence', emoji: 'ğŸ“ˆ', text: 'ì„±ì ì´ ì•ˆ ì˜¬ë¼ë„ ê³„ì† ë…¸ë ¥í•  ìˆ˜ ìˆë‹¤' },
            { area: 'persistence', emoji: 'ğŸ®', text: 'ê²Œì„ì—ì„œ ì–´ë ¤ìš´ ìŠ¤í…Œì´ì§€ë„ í´ë¦¬ì–´í•  ë•Œê¹Œì§€ í•œë‹¤' },
            { area: 'selfcontrol', emoji: 'ğŸ«', text: 'ì¢‹ì•„í•˜ëŠ” ê²ƒë„ ì°¸ê³  í•´ì•¼ í•  ê²ƒë¶€í„° í•˜ëŠ” í¸ì´ë‹¤' },
            { area: 'selfcontrol', emoji: 'ğŸ“±', text: 'ìœ íŠœë¸Œë‚˜ SNS ì‹œê°„ì„ ìŠ¤ìŠ¤ë¡œ ì¡°ì ˆí•  ìˆ˜ ìˆë‹¤' },
            { area: 'selfcontrol', emoji: 'ğŸ›ï¸', text: 'ìê³  ì‹¶ì–´ë„ í•  ì¼ì´ ë‚¨ìœ¼ë©´ ì•ˆ ìëŠ” í¸ì´ë‹¤' },
            { area: 'selfcontrol', emoji: 'ğŸ•', text: 'ì‹œí—˜ ê¸°ê°„ì—ëŠ” ë…¸ëŠ” ê²ƒì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤' },
            { area: 'selfcontrol', emoji: 'ğŸ˜´', text: 'ëŠ¦ê²Œ ìë„ ë‹¤ìŒ ë‚  ì¼ì° ì¼ì–´ë‚  ìˆ˜ ìˆë‹¤' }
        ];

        const areaNames = { planning: 'ê³„íšë ¥', focus: 'ì§‘ì¤‘ë ¥', execution: 'ì‹¤í–‰ë ¥', persistence: 'ëˆê¸°', selfcontrol: 'ìê¸°ì¡°ì ˆ' };
        const areaIcons = { planning: 'bi-calendar-check', focus: 'bi-eye', execution: 'bi-lightning', persistence: 'bi-fire', selfcontrol: 'bi-sliders' };
        const areaColors = { planning: '#667eea', focus: '#28a745', execution: '#fd7e14', persistence: '#dc3545', selfcontrol: '#6f42c1' };

        let currentQuestion = 0, answers = [], userName = '', userGrade = '';

        function startTest() {
            userName = document.getElementById('userName').value.trim() || 'ìµëª…';
            userGrade = document.getElementById('userGrade').value || 'ë¯¸ì„ íƒ';
            playStartSound(); // ì‹œì‘ ì•Œë¦¼ìŒ
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('testScreen').classList.remove('hidden');
            document.getElementById('testScreen').classList.add('fade-in');
            showQuestion();
        }

        function showQuestion() {
            const q = questions[currentQuestion];
            document.getElementById('questionNum').innerHTML = '<i class="bi bi-question-circle"></i> ' + (currentQuestion + 1) + ' / ' + questions.length;
            document.getElementById('progressBar').style.width = ((currentQuestion + 1) / questions.length * 100) + '%';
            document.getElementById('areaName').textContent = areaNames[q.area];
            document.getElementById('questionEmoji').textContent = q.emoji;
            document.getElementById('questionText').textContent = q.text;
            document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
        }

        function selectAnswer(value) {
            answers.push({ question: currentQuestion, area: questions[currentQuestion].area, value: value });
            currentQuestion++;
            if (currentQuestion < questions.length) {
                playNextSound(); // ë‹¤ìŒ ì§ˆë¬¸ ì•Œë¦¼ìŒ
                document.getElementById('testScreen').classList.remove('fade-in');
                setTimeout(() => { document.getElementById('testScreen').classList.add('fade-in'); showQuestion(); }, 100);
            } else { showResult(); }
        }

        function calculateScores() {
            const scores = { planning: 0, focus: 0, execution: 0, persistence: 0, selfcontrol: 0 };
            const counts = { planning: 0, focus: 0, execution: 0, persistence: 0, selfcontrol: 0 };
            answers.forEach(a => { scores[a.area] += a.value; counts[a.area]++; });
            for (let area in scores) { scores[area] = Math.round((scores[area] / (counts[area] * 4)) * 100); }
            return scores;
        }

        function showResult() {
            playCompleteSound(); // ì™„ë£Œ ì•Œë¦¼ìŒ
            document.getElementById('testScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('resultScreen').classList.add('fade-in');
            const scores = calculateScores();
            const total = Math.round((scores.planning + scores.focus + scores.execution + scores.persistence + scores.selfcontrol) / 5);
            const { type, emoji, desc } = determineType(scores, total);
            document.getElementById('resultEmoji').textContent = emoji;
            document.getElementById('resultType').textContent = type;
            document.getElementById('resultDesc').textContent = desc;
            document.getElementById('totalScoreBadge').textContent = total + 'ì ';

            const areaScoresDiv = document.getElementById('areaScores');
            areaScoresDiv.innerHTML = '';
            for (let area in scores) {
                areaScoresDiv.innerHTML += '<div class="area-item"><div class="d-flex justify-content-between"><span class="area-name"><i class="bi ' + areaIcons[area] + '" style="color:' + areaColors[area] + '"></i> ' + areaNames[area] + '</span><span class="fw-bold">' + scores[area] + 'ì </span></div><div class="area-bar"><div class="area-fill" style="width: ' + scores[area] + '%; background: linear-gradient(90deg, ' + areaColors[area] + ', ' + areaColors[area] + '99);"></div></div></div>';
            }
            document.getElementById('adviceText').textContent = getAdvice(scores);
            createRadarChart(scores);
            saveResult(scores, total, type);
        }

        function determineType(scores, total) {
            if (total >= 80) return { type: 'ğŸ† ìê¸°ì£¼ë„ í•™ìŠµì', emoji: 'ğŸ†', desc: 'ìŠ¤ìŠ¤ë¡œ ê³„íší•˜ê³  ì‹¤ì²œí•˜ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ìš”!' };
            if (total >= 65) return { type: 'ğŸŒ± ì„±ì¥í˜• í•™ìŠµì', emoji: 'ğŸŒ±', desc: 'ê¸°ë³¸ê¸°ê°€ ì¢‹ì•„ìš”. ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•˜ë©´ ê¸‰ì„±ì¥!' };
            if (scores.planning >= 70 && scores.execution < 50) return { type: 'ğŸ’­ ê³„íší˜• ëª½ìƒê°€', emoji: 'ğŸ’­', desc: 'ê³„íšì€ ì˜ ì„¸ìš°ëŠ”ë° ì‹¤ì²œì´ ì•„ì‰¬ì›Œìš”' };
            if (scores.execution >= 70 && scores.planning < 50) return { type: 'âš¡ ì¦‰í¥ì  ì‹¤í–‰ê°€', emoji: 'âš¡', desc: 'ì¼ë‹¨ í•˜ê³  ë³´ëŠ” ìŠ¤íƒ€ì¼!' };
            if (scores.persistence >= 70) return { type: 'ğŸ”¥ ëˆê¸°ì˜ ë‹¬ì¸', emoji: 'ğŸ”¥', desc: 'í¬ê¸°ë¥¼ ëª¨ë¥´ëŠ” ë‹¹ì‹ !' };
            if (scores.focus >= 70) return { type: 'ğŸ¯ ì§‘ì¤‘ë ¥ ë§ˆìŠ¤í„°', emoji: 'ğŸ¯', desc: 'ëª°ì…ë ¥ì´ ëŒ€ë‹¨í•´ìš”!' };
            if (total < 40) return { type: 'ğŸ’ ì ì¬ë ¥ ë³´ìœ ì', emoji: 'ğŸ’', desc: 'ê°€ëŠ¥ì„±ì€ ë¬´í•œí•´ìš”!' };
            return { type: 'âš–ï¸ ê· í˜•ì¡íŒ í•™ìŠµì', emoji: 'âš–ï¸', desc: 'ê³ ë¥´ê²Œ ë°œì „ ì¤‘!' };
        }

        function getAdvice(scores) {
            const weakest = Object.keys(scores).reduce((a, b) => scores[a] < scores[b] ? a : b);
            const advices = { planning: 'í•˜ë£¨ 3ê°€ì§€ë§Œ í•  ì¼ì„ ì •í•´ë³´ì„¸ìš”!', focus: '25ë¶„ ì§‘ì¤‘ + 5ë¶„ íœ´ì‹ í•´ë³´ì„¸ìš”!', execution: '5ì´ˆ ì•ˆì— ì‹œì‘í•˜ê¸°!', persistence: 'ì‘ì€ ì„±ê³µ ê²½í—˜ì„ ìŒ“ì•„ë³´ì„¸ìš”!', selfcontrol: 'ìŠ¤ë§ˆíŠ¸í° íƒ€ì´ë¨¸ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”!' };
            return areaNames[weakest] + 'ì´(ê°€) ì¡°ê¸ˆ ì•„ì‰¬ì›Œìš”. ' + advices[weakest];
        }

        function createRadarChart(scores) {
            new Chart(document.getElementById('radarChart').getContext('2d'), {
                type: 'radar',
                data: { labels: ['ê³„íšë ¥', 'ì§‘ì¤‘ë ¥', 'ì‹¤í–‰ë ¥', 'ëˆê¸°', 'ìê¸°ì¡°ì ˆ'], datasets: [{ label: 'ë‚˜ì˜ ì ìˆ˜', data: [scores.planning, scores.focus, scores.execution, scores.persistence, scores.selfcontrol], backgroundColor: 'rgba(102, 126, 234, 0.3)', borderColor: 'rgba(102, 126, 234, 1)', borderWidth: 3, pointBackgroundColor: 'rgba(102, 126, 234, 1)', pointRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 20, display: false }, pointLabels: { font: { size: 13, weight: 'bold' } } } }, plugins: { legend: { display: false } } }
            });
        }

        function saveResult(scores, total, type) { fetch('/save_result', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: userName, grade: userGrade, ...scores, total: total, type: type }) }); }

        function showAIPrompt() {
            const scores = calculateScores();
            const total = Math.round((scores.planning + scores.focus + scores.execution + scores.persistence + scores.selfcontrol) / 5);
            fetch('/generate_prompt', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: userName, grade: userGrade, ...scores, total: total, type: determineType(scores, total).type }) })
            .then(res => res.json()).then(data => { document.getElementById('aiPrompt').value = data.prompt; document.getElementById('aiPromptBox').classList.remove('hidden'); });
        }

        function copyPrompt() { document.getElementById('aiPrompt').select(); document.execCommand('copy'); alert('ë³µì‚¬ ì™„ë£Œ!'); }

        function analyzeWithAI() {
            const scores = calculateScores();
            const total = Math.round((scores.planning + scores.focus + scores.execution + scores.persistence + scores.selfcontrol) / 5);
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingBox').classList.remove('hidden');
            document.getElementById('analysisResultBox').classList.add('hidden');
            document.getElementById('errorBox').classList.add('hidden');
            fetch('/analyze_with_ai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: userName, grade: userGrade, ...scores, total: total, type: determineType(scores, total).type }) })
            .then(res => res.json()).then(data => {
                document.getElementById('loadingBox').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
                if (data.status === 'success') {
                    playCompleteSound(); // AI ë¶„ì„ ì™„ë£Œ ì•Œë¦¼ìŒ
                    document.getElementById('analysisResult').innerHTML = marked.parse(data.analysis);
                    document.getElementById('analysisResultBox').classList.remove('hidden');
                }
                else {
                    playErrorSound(); // ì—ëŸ¬ ì•Œë¦¼ìŒ
                    document.getElementById('errorMessage').textContent = data.message;
                    document.getElementById('errorBox').classList.remove('hidden');
                }
            }).catch(error => {
                playErrorSound(); // ì—ëŸ¬ ì•Œë¦¼ìŒ
                document.getElementById('loadingBox').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('errorMessage').textContent = 'ì„œë²„ ì˜¤ë¥˜: ' + error.message;
                document.getElementById('errorBox').classList.remove('hidden');
            });
        }

        function copyAnalysis() { navigator.clipboard.writeText(document.getElementById('analysisResult').innerText).then(() => alert('ë³µì‚¬ ì™„ë£Œ!')); }

        function restartTest() { currentQuestion = 0; answers = []; document.getElementById('resultScreen').classList.add('hidden'); document.getElementById('aiPromptBox').classList.add('hidden'); document.getElementById('analysisResultBox').classList.add('hidden'); document.getElementById('startScreen').classList.remove('hidden'); }
    </script>
</body>
</html>
