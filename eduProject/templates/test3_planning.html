{% extends 'base.html' %}

{% block title %}영역 3: 계획 및 목표설정{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- 진행 상태 -->
        <div class="progress mb-4" style="height: 25px;">
            <div class="progress-bar" role="progressbar" style="width: 60%;">
                3 / 5 영역
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <span class="badge bg-light text-primary me-2">영역 3</span>
                    계획 및 목표설정 능력
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> 상황 설명</h5>
                    <p class="mb-2">
                        <strong>3주 후 중간고사가 있습니다.</strong><br>
                        시험 과목: 국어, 수학, 영어, 한국사, 탐구(선택)
                    </p>
                    <p class="mb-0">
                        아래 양식에 따라 <strong>학습 계획</strong>을 작성해 주세요.<br>
                        평소 계획을 세우는 방식대로 솔직하게 작성하면 됩니다.
                    </p>
                </div>

                <form id="test3Form">
                    <!-- Part 1: 과목별 목표 설정 -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <strong><i class="bi bi-bullseye"></i> Part 1: 과목별 목표 설정</strong>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>과목</th>
                                            <th>지난 시험 등급/점수</th>
                                            <th>목표 등급/점수</th>
                                            <th>달성 전략 (간단히)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>국어</strong></td>
                                            <td><input type="text" class="form-control form-control-sm" name="prev_korean" placeholder="예: 3등급, 75점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="goal_korean" placeholder="예: 2등급, 85점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="strategy_korean" placeholder="예: 비문학 매일 1지문"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>수학</strong></td>
                                            <td><input type="text" class="form-control form-control-sm" name="prev_math" placeholder="예: 4등급, 65점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="goal_math" placeholder="예: 3등급, 75점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="strategy_math" placeholder="예: 기출문제 풀이"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>영어</strong></td>
                                            <td><input type="text" class="form-control form-control-sm" name="prev_english" placeholder="예: 2등급, 88점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="goal_english" placeholder="예: 1등급, 95점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="strategy_english" placeholder="예: 단어 암기, 독해"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>한국사</strong></td>
                                            <td><input type="text" class="form-control form-control-sm" name="prev_history" placeholder="예: 3등급, 72점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="goal_history" placeholder="예: 2등급, 82점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="strategy_history" placeholder="예: 연표 정리"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>탐구</strong></td>
                                            <td><input type="text" class="form-control form-control-sm" name="prev_science" placeholder="예: 3등급, 70점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="goal_science" placeholder="예: 2등급, 80점"></td>
                                            <td><input type="text" class="form-control form-control-sm" name="strategy_science" placeholder="예: 개념 복습"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Part 2: 3주 학습 계획표 -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <strong><i class="bi bi-calendar3"></i> Part 2: 3주 학습 계획표</strong>
                            <small class="text-muted ms-2">(구체적으로 작성할수록 좋습니다)</small>
                        </div>
                        <div class="card-body">
                            <!-- 1주차 -->
                            <h6 class="text-primary mb-3"><i class="bi bi-1-circle"></i> 1주차 계획</h6>
                            <div class="row g-2 mb-4">
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">월요일</label>
                                    <textarea class="form-control form-control-sm" name="week1_mon" rows="2" placeholder="예: 수학 2단원 복습 (2시간)"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">화요일</label>
                                    <textarea class="form-control form-control-sm" name="week1_tue" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">수요일</label>
                                    <textarea class="form-control form-control-sm" name="week1_wed" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">목요일</label>
                                    <textarea class="form-control form-control-sm" name="week1_thu" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">금요일</label>
                                    <textarea class="form-control form-control-sm" name="week1_fri" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">주말</label>
                                    <textarea class="form-control form-control-sm" name="week1_weekend" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                            </div>

                            <!-- 2주차 -->
                            <h6 class="text-primary mb-3"><i class="bi bi-2-circle"></i> 2주차 계획</h6>
                            <div class="row g-2 mb-4">
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">월요일</label>
                                    <textarea class="form-control form-control-sm" name="week2_mon" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">화요일</label>
                                    <textarea class="form-control form-control-sm" name="week2_tue" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">수요일</label>
                                    <textarea class="form-control form-control-sm" name="week2_wed" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">목요일</label>
                                    <textarea class="form-control form-control-sm" name="week2_thu" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">금요일</label>
                                    <textarea class="form-control form-control-sm" name="week2_fri" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">주말</label>
                                    <textarea class="form-control form-control-sm" name="week2_weekend" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                            </div>

                            <!-- 3주차 (시험 주) -->
                            <h6 class="text-primary mb-3"><i class="bi bi-3-circle"></i> 3주차 계획 (시험 주)</h6>
                            <div class="row g-2">
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">월요일</label>
                                    <textarea class="form-control form-control-sm" name="week3_mon" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">화요일</label>
                                    <textarea class="form-control form-control-sm" name="week3_tue" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">수요일</label>
                                    <textarea class="form-control form-control-sm" name="week3_wed" rows="2" placeholder="학습 계획 입력"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">목요일 (시험)</label>
                                    <textarea class="form-control form-control-sm" name="week3_thu" rows="2" placeholder="시험 전날 계획"></textarea>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <label class="form-label small">금요일 (시험)</label>
                                    <textarea class="form-control form-control-sm" name="week3_fri" rows="2" placeholder="시험 당일"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Part 3: 자기 평가 -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <strong><i class="bi bi-patch-question"></i> Part 3: 자기 평가</strong>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">1. 위 계획을 실제로 실천할 자신감은 몇 %인가요?</label>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <input type="range" class="form-range" name="confidence" min="0" max="100" value="50" id="confidenceRange">
                                    </div>
                                    <div class="col-md-4">
                                        <span class="badge bg-primary fs-5" id="confidenceValue">50%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">2. 계획 실천에 가장 큰 방해 요소는? (복수 선택 가능)</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="obstacles" value="smartphone" id="obs1">
                                            <label class="form-check-label" for="obs1">스마트폰/SNS</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="obstacles" value="fatigue" id="obs2">
                                            <label class="form-check-label" for="obs2">피로/체력</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="obstacles" value="focus" id="obs3">
                                            <label class="form-check-label" for="obs3">집중력 부족</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="obstacles" value="motivation" id="obs4">
                                            <label class="form-check-label" for="obs4">의지/동기 부족</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="obstacles" value="schedule" id="obs5">
                                            <label class="form-check-label" for="obs5">학원/과외 일정</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="obstacles" value="other" id="obs6">
                                            <label class="form-check-label" for="obs6">기타</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">3. 평소 계획을 세울 때 어려운 점이 있다면?</label>
                                <textarea class="form-control" name="difficulty" rows="3" placeholder="자유롭게 작성해 주세요"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="/test2" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 이전 영역
                        </a>
                        <div>
                            <button type="button" class="btn btn-warning me-2" onclick="autoFillTest()">
                                <i class="bi bi-lightning"></i> 테스트모드 (90점)
                            </button>
                            <button type="button" class="btn btn-primary btn-lg" onclick="submitTest3()">
                                다음 영역으로 <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 자신감 슬라이더 값 표시
document.getElementById('confidenceRange').addEventListener('input', function() {
    document.getElementById('confidenceValue').textContent = this.value + '%';
});

function autoFillTest() {
    // 과목별 목표 설정 자동 입력
    document.querySelector('input[name="prev_korean"]').value = '3등급, 75점';
    document.querySelector('input[name="goal_korean"]').value = '2등급, 85점';
    document.querySelector('input[name="strategy_korean"]').value = '비문학 매일 1지문, 문법 정리';

    document.querySelector('input[name="prev_math"]').value = '3등급, 72점';
    document.querySelector('input[name="goal_math"]').value = '2등급, 82점';
    document.querySelector('input[name="strategy_math"]').value = '기출문제 풀이, 오답노트 작성';

    document.querySelector('input[name="prev_english"]').value = '2등급, 88점';
    document.querySelector('input[name="goal_english"]').value = '1등급, 95점';
    document.querySelector('input[name="strategy_english"]').value = '단어 암기 50개/일, 독해 연습';

    document.querySelector('input[name="prev_history"]').value = '3등급, 70점';
    document.querySelector('input[name="goal_history"]').value = '2등급, 80점';
    document.querySelector('input[name="strategy_history"]').value = '연표 정리, 기출문제 분석';

    document.querySelector('input[name="prev_science"]').value = '3등급, 72점';
    document.querySelector('input[name="goal_science"]').value = '2등급, 82점';
    document.querySelector('input[name="strategy_science"]').value = '개념 복습, 실험 정리';

    // 주간 계획 자동 입력
    document.querySelector('textarea[name="week1_mon"]').value = '수학 2단원 복습 (2시간), 영어 단어 50개';
    document.querySelector('textarea[name="week1_tue"]').value = '국어 비문학 3지문, 한국사 1단원';
    document.querySelector('textarea[name="week1_wed"]').value = '수학 기출문제 풀이, 탐구 개념정리';
    document.querySelector('textarea[name="week1_thu"]').value = '영어 독해 연습, 국어 문법';
    document.querySelector('textarea[name="week1_fri"]').value = '수학 오답정리, 한국사 연표';
    document.querySelector('textarea[name="week1_weekend"]').value = '주간 복습, 부족한 부분 보충';

    document.querySelector('textarea[name="week2_mon"]').value = '수학 3단원 심화, 영어 단어';
    document.querySelector('textarea[name="week2_tue"]').value = '국어 모의고사 1회, 한국사 2단원';
    document.querySelector('textarea[name="week2_wed"]').value = '수학 기출, 탐구 문제풀이';
    document.querySelector('textarea[name="week2_thu"]').value = '영어 모의고사, 국어 화법';
    document.querySelector('textarea[name="week2_fri"]').value = '전과목 오답정리';
    document.querySelector('textarea[name="week2_weekend"]').value = '모의고사 풀이, 취약점 보완';

    document.querySelector('textarea[name="week3_mon"]').value = '수학 핵심 개념 복습';
    document.querySelector('textarea[name="week3_tue"]').value = '국어/영어 마무리 정리';
    document.querySelector('textarea[name="week3_wed"]').value = '한국사/탐구 최종 점검';
    document.querySelector('textarea[name="week3_thu"]').value = '시험 전날 가벼운 복습';
    document.querySelector('textarea[name="week3_fri"]').value = '시험';

    // 자신감 90%로 설정
    document.getElementById('confidenceRange').value = 90;
    document.getElementById('confidenceValue').textContent = '90%';

    // 방해 요소 선택
    document.getElementById('obs1').checked = true; // 스마트폰
    document.getElementById('obs3').checked = true; // 집중력

    // 어려운 점 입력
    document.querySelector('textarea[name="difficulty"]').value = '계획을 세워도 실천하기 어렵고, 예상보다 시간이 오래 걸림';

    submitTest3();
}

function submitTest3() {
    // 계획 내용 수집
    const formData = new FormData(document.getElementById('test3Form'));
    const planData = {};

    for (let [key, value] of formData.entries()) {
        if (key === 'obstacles') {
            if (!planData.obstacles) planData.obstacles = [];
            planData.obstacles.push(value);
        } else {
            planData[key] = value;
        }
    }

    // 점수 계산 (자동 평가 기준)
    let specificity = 0;   // 목표의 구체성
    let realism = 0;       // 목표의 현실성 (자기평가 신뢰도로 대체)
    let planDetail = 0;    // 계획의 구체성
    let balance = 0;       // 균형성
    let feasibility = 0;   // 실행 가능성

    // 목표 구체성 평가 (목표 입력 여부)
    const goalFields = ['goal_korean', 'goal_math', 'goal_english', 'goal_history', 'goal_science'];
    goalFields.forEach(field => {
        if (planData[field] && planData[field].trim().length > 0) {
            specificity += 4;
        }
    });

    // 전략 구체성 평가
    const strategyFields = ['strategy_korean', 'strategy_math', 'strategy_english', 'strategy_history', 'strategy_science'];
    strategyFields.forEach(field => {
        if (planData[field] && planData[field].trim().length > 5) {
            specificity += 2;
            planDetail += 2;
        }
    });

    // 계획 상세도 평가 (주간 계획 입력 여부)
    const weekFields = [
        'week1_mon', 'week1_tue', 'week1_wed', 'week1_thu', 'week1_fri', 'week1_weekend',
        'week2_mon', 'week2_tue', 'week2_wed', 'week2_thu', 'week2_fri', 'week2_weekend',
        'week3_mon', 'week3_tue', 'week3_wed', 'week3_thu', 'week3_fri'
    ];

    let filledCount = 0;
    weekFields.forEach(field => {
        if (planData[field] && planData[field].trim().length > 5) {
            filledCount++;
        }
    });

    planDetail += Math.min(Math.round((filledCount / weekFields.length) * 10), 10);

    // 균형성 (다양한 과목 전략 작성 여부)
    let subjectCount = 0;
    strategyFields.forEach(field => {
        if (planData[field] && planData[field].trim().length > 0) {
            subjectCount++;
        }
    });
    balance = Math.round((subjectCount / 5) * 20);

    // 실행 가능성 (자신감 점수 반영)
    const confidence = parseInt(planData.confidence || 50);
    feasibility = Math.round(confidence / 5);

    // 현실성 (자기인식 점수로 대체)
    realism = Math.round(confidence / 5);

    // 점수 상한 적용
    specificity = Math.min(specificity, 20);
    planDetail = Math.min(planDetail, 20);

    const totalScore = specificity + realism + planDetail + balance + feasibility;

    // 계획 텍스트 요약
    let planText = '';
    for (let [key, value] of Object.entries(planData)) {
        if (value && typeof value === 'string' && value.trim().length > 0) {
            planText += `${key}: ${value}\n`;
        }
    }

    // 결과 저장
    const result = {
        score: totalScore,
        specificity: specificity,
        realism: realism,
        plan_detail: planDetail,
        balance: balance,
        feasibility: feasibility,
        confidence: confidence,
        obstacles: planData.obstacles || [],
        difficulty: planData.difficulty || '',
        plan_text: planText
    };

    // localStorage에 저장
    let testResults = JSON.parse(localStorage.getItem('testResults') || '{}');
    testResults.test3 = result;
    localStorage.setItem('testResults', JSON.stringify(testResults));

    // 서버에도 저장
    fetch('/save_result', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({test_name: 'test3', result: result})
    }).then(() => {
        playNextSound(); // 다음 영역 알림음
        setTimeout(() => {
            window.location.href = '/test4';
        }, 300);
    });
}
</script>
{% endblock %}
