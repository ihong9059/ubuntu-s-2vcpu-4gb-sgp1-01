<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}메타인지 테스트{% endblock %} - Sam English</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="{{ url_for('static', filename='images/sam_english_logo.svg') }}" alt="Sam English" height="50" class="me-2" style="background: white; padding: 3px; border-radius: 5px;">
            </a>
            <span class="navbar-text text-white">
                메타인지 진단 테스트
            </span>
        </div>
    </nav>

    <main class="container my-4">
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-light py-3 mt-5">
        <div class="container text-center text-muted">
            <small>&copy; 2024 Sam English - 맞춤형 진학 컨설팅 서비스</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" ></script>

    <!-- 알림음 시스템 -->
    <script>
        let audioCtx = null;
        let soundEnabled = true;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            return audioCtx;
        }

        // 다음 단계 알림음
        function playNextSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const gain1 = ctx.createGain();
                const gain2 = ctx.createGain();

                osc1.connect(gain1); gain1.connect(ctx.destination);
                osc2.connect(gain2); gain2.connect(ctx.destination);

                osc1.frequency.value = 880;
                osc2.frequency.value = 1108.73;
                osc1.type = 'sine';
                osc2.type = 'sine';

                gain1.gain.setValueAtTime(0.8, ctx.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                gain2.gain.setValueAtTime(0.8, ctx.currentTime + 0.08);
                gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);

                osc1.start(ctx.currentTime); osc1.stop(ctx.currentTime + 0.15);
                osc2.start(ctx.currentTime + 0.08); osc2.stop(ctx.currentTime + 0.25);
            } catch (e) { console.error('playNextSound 오류:', e); }
        }

        // 시작 알림음
        function playStartSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    const startTime = ctx.currentTime + i * 0.12;
                    gain.gain.setValueAtTime(0.7, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                    osc.start(startTime); osc.stop(startTime + 0.3);
                });
            } catch (e) { console.error('playStartSound 오류:', e); }
        }

        // 완료 알림음
        function playCompleteSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                const melody = [
                    { freq: 523.25, time: 0, dur: 0.2 },
                    { freq: 659.25, time: 0.15, dur: 0.2 },
                    { freq: 783.99, time: 0.3, dur: 0.2 },
                    { freq: 1046.50, time: 0.45, dur: 0.4 }
                ];
                melody.forEach(note => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = note.freq;
                    osc.type = 'sine';
                    const startTime = ctx.currentTime + note.time;
                    gain.gain.setValueAtTime(0.8, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + note.dur);
                    osc.start(startTime); osc.stop(startTime + note.dur);
                });
            } catch (e) { console.error('playCompleteSound 오류:', e); }
        }

        // 에러 알림음
        function playErrorSound() {
            if (!soundEnabled) return;
            try {
                const ctx = initAudio();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.3);
                osc.type = 'sawtooth';
                gain.gain.setValueAtTime(0.6, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.4);
            } catch (e) { console.error('playErrorSound 오류:', e); }
        }

        // 첫 클릭 시 오디오 활성화
        document.addEventListener('click', function initOnFirstClick() {
            initAudio();
            document.removeEventListener('click', initOnFirstClick);
        }, { once: true });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
