{% extends 'base.html' %}

{% block title %}영역 1: 자기인식 정확도{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- 진행 상태 -->
        <div class="progress mb-4" style="height: 25px;">
            <div class="progress-bar" role="progressbar" style="width: 20%;">
                1 / 5 영역
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <span class="badge bg-light text-primary me-2">영역 1</span>
                    자기인식 정확도 테스트
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> 테스트 방법</h5>
                    <ol class="mb-0">
                        <li>각 문제를 보고 <strong>풀기 전에</strong> 맞출 자신감을 선택하세요.</li>
                        <li>자신감을 선택한 후 문제를 풀어주세요.</li>
                        <li>예측과 실제 결과를 비교하여 자기인식 정확도를 측정합니다.</li>
                    </ol>
                </div>

                <!-- 과목 선택 -->
                <div class="mb-4">
                    <label class="form-label"><strong>주요 과목 선택</strong> (분석에 활용됩니다)</label>
                    <select class="form-select" id="subjectSelect">
                        <option value="국어">국어</option>
                        <option value="수학" selected>수학</option>
                        <option value="영어">영어</option>
                    </select>
                </div>

                <!-- 학년 표시 -->
                <div class="alert alert-secondary mb-4">
                    <strong><i class="bi bi-mortarboard"></i> 현재 학년:</strong>
                    <span id="currentGradeDisplay">고등학교 2학년</span>
                    <small class="text-muted">(학년에 맞는 문제가 출제됩니다)</small>
                </div>

                <form id="test1Form">
                    <!-- 문제들이 JavaScript로 동적 생성됨 -->
                    <div id="questionsContainer"></div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> 처음으로
                        </a>
                        <div>
                            <button type="button" class="btn btn-warning me-2" onclick="autoFillTest()">
                                <i class="bi bi-lightning"></i> 테스트모드 (90점)
                            </button>
                            <button type="button" class="btn btn-primary btn-lg" onclick="submitTest1()">
                                다음 영역으로 <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 학년별 문제 데이터
const questionsByGrade = {
    // 고등학교 1학년: 중학교 ~ 고1 1학기 수준
    '1': {
        questions: [
            {
                text: '다음 수식의 값을 구하시오: 2x + 3 = 11 일 때, x의 값은?',
                options: ['3', '4', '5', '6'],
                answer: '4'
            },
            {
                text: '이차방정식 x² - 5x + 6 = 0의 두 근의 합은?',
                options: ['4', '5', '6', '7'],
                answer: '5'
            },
            {
                text: '(x + 2)(x - 3)을 전개하면?',
                options: ['x² - x - 6', 'x² + x - 6', 'x² - x + 6', 'x² - 5x - 6'],
                answer: 'x² - x - 6'
            },
            {
                text: '직각삼각형에서 두 변의 길이가 3, 4일 때, 빗변의 길이는?',
                options: ['5', '6', '7', '8'],
                answer: '5'
            },
            {
                text: '√48을 간단히 하면?',
                options: ['4√3', '2√12', '6√2', '3√4'],
                answer: '4√3'
            }
        ],
        description: '중학교 ~ 고1 1학기 범위'
    },
    // 고등학교 2학년: 고1 전체 범위
    '2': {
        questions: [
            {
                text: '이차방정식 x² - 5x + 6 = 0의 두 근의 합은?',
                options: ['4', '5', '6', '7'],
                answer: '5'
            },
            {
                text: 'sin²θ + cos²θ 의 값은?',
                options: ['0', '1', '2', '-1'],
                answer: '1'
            },
            {
                text: 'log₁₀100 의 값은?',
                options: ['1', '2', '10', '100'],
                answer: '2'
            },
            {
                text: '등차수열 2, 5, 8, 11, ... 의 제10항은?',
                options: ['27', '29', '30', '32'],
                answer: '29'
            },
            {
                text: '함수 f(x) = 2x + 1에서 f(3)의 값은?',
                options: ['5', '6', '7', '8'],
                answer: '7'
            }
        ],
        description: '고1 전체 범위 (삼각함수, 로그, 수열 포함)'
    },
    // 고등학교 3학년: 고2 범위 포함
    '3': {
        questions: [
            {
                text: 'sin²θ + cos²θ 의 값은?',
                options: ['0', '1', '2', '-1'],
                answer: '1'
            },
            {
                text: 'log₂8 의 값은?',
                options: ['2', '3', '4', '8'],
                answer: '3'
            },
            {
                text: '함수 f(x) = x²의 x = 2에서의 미분계수는?',
                options: ['2', '4', '6', '8'],
                answer: '4'
            },
            {
                text: '등비수열 2, 6, 18, 54, ... 의 공비는?',
                options: ['2', '3', '4', '6'],
                answer: '3'
            },
            {
                text: '∫₀¹ 2x dx 의 값은?',
                options: ['0', '1', '2', '4'],
                answer: '1'
            }
        ],
        description: '고2 범위 (미적분 포함)'
    }
};

// 현재 학년과 정답 데이터
let currentGrade = '2';
let correctAnswers = {};

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', function() {
    // localStorage에서 학년 정보 가져오기
    const studentInfo = JSON.parse(localStorage.getItem('studentInfo') || '{}');
    currentGrade = studentInfo.grade || '2';

    // 학년 표시 업데이트
    document.getElementById('currentGradeDisplay').textContent = `고등학교 ${currentGrade}학년`;

    // 문제 생성
    generateQuestions();
});

// 문제 HTML 생성
function generateQuestions() {
    const gradeData = questionsByGrade[currentGrade];
    const container = document.getElementById('questionsContainer');

    let html = '';
    gradeData.questions.forEach((q, index) => {
        const qNum = index + 1;
        correctAnswers[qNum] = q.answer;

        html += `
            <div class="card mb-3 question-card" data-question="${qNum}">
                <div class="card-header">
                    <strong>문제 ${qNum}</strong>
                </div>
                <div class="card-body">
                    <p class="question-text">${q.text}</p>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label text-primary"><strong>1단계: 맞출 자신감은?</strong></label>
                            <div class="confidence-options">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="conf${qNum}" value="90" id="conf${qNum}_90">
                                    <label class="form-check-label" for="conf${qNum}_90">확실히 맞음 (90%↑)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="conf${qNum}" value="70" id="conf${qNum}_70">
                                    <label class="form-check-label" for="conf${qNum}_70">아마 맞을 것 (70~89%)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="conf${qNum}" value="50" id="conf${qNum}_50">
                                    <label class="form-check-label" for="conf${qNum}_50">반반 (50~69%)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="conf${qNum}" value="30" id="conf${qNum}_30">
                                    <label class="form-check-label" for="conf${qNum}_30">틀릴 가능성 높음 (30~49%)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="conf${qNum}" value="10" id="conf${qNum}_10">
                                    <label class="form-check-label" for="conf${qNum}_10">모르겠음 (30%↓)</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-success"><strong>2단계: 답을 선택하세요</strong></label>
                            <div class="answer-options">
                                ${q.options.map((opt, i) => `
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="ans${qNum}" value="${opt}" id="ans${qNum}_${i}">
                                        <label class="form-check-label" for="ans${qNum}_${i}">① ${opt}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // 보기 번호 수정 (①②③④)
    const symbols = ['①', '②', '③', '④'];
    container.querySelectorAll('.answer-options').forEach(optDiv => {
        optDiv.querySelectorAll('label').forEach((label, i) => {
            const text = label.textContent.replace(/^① /, '');
            label.textContent = `${symbols[i]} ${text}`;
        });
    });
}

// 테스트 모드: 자동으로 90점 이상 나오도록 설정
function autoFillTest() {
    // 모든 문제에 정답과 높은 자신감 선택
    for (let i = 1; i <= 5; i++) {
        document.querySelector(`input[name="conf${i}"][value="90"]`).checked = true;
        const correctAns = correctAnswers[i];
        document.querySelector(`input[name="ans${i}"][value="${correctAns}"]`).checked = true;
    }
    // 자동 제출
    submitTest1();
}

function submitTest1() {
    // 모든 문항 응답 확인
    for (let i = 1; i <= 5; i++) {
        const conf = document.querySelector(`input[name="conf${i}"]:checked`);
        const ans = document.querySelector(`input[name="ans${i}"]:checked`);

        if (!conf) {
            alert(`문제 ${i}번의 자신감을 선택해 주세요.`);
            return;
        }
        if (!ans) {
            alert(`문제 ${i}번의 답을 선택해 주세요.`);
            return;
        }
    }

    // 결과 계산
    let overestimate = 0;  // 과대평가
    let underestimate = 0; // 과소평가
    let accurate = 0;      // 정확
    let totalScore = 0;

    for (let i = 1; i <= 5; i++) {
        const conf = parseInt(document.querySelector(`input[name="conf${i}"]:checked`).value);
        const ans = document.querySelector(`input[name="ans${i}"]:checked`).value;
        const isCorrect = ans === correctAnswers[i];

        // 자신감 높음(70 이상) + 틀림 = 과대평가
        // 자신감 낮음(50 이하) + 맞음 = 과소평가
        // 그 외 = 정확
        if (conf >= 70 && !isCorrect) {
            overestimate++;
        } else if (conf <= 50 && isCorrect) {
            underestimate++;
        } else if ((conf >= 70 && isCorrect) || (conf <= 50 && !isCorrect)) {
            accurate++;
        } else {
            accurate++; // 중간 자신감
        }
    }

    // 점수 계산 (정확 예측 비율)
    totalScore = Math.round((accurate / 5) * 100);

    // 유형 판정
    let type = '정확형';
    if (overestimate > underestimate && overestimate >= 2) {
        type = '과대평가형';
    } else if (underestimate > overestimate && underestimate >= 2) {
        type = '과소평가형';
    }

    // 결과 저장
    const result = {
        score: totalScore,
        type: type,
        overestimate: overestimate,
        underestimate: underestimate,
        accurate: accurate,
        subject: document.getElementById('subjectSelect').value,
        grade: currentGrade,
        gradeDescription: questionsByGrade[currentGrade].description
    };

    // localStorage에 저장
    let testResults = JSON.parse(localStorage.getItem('testResults') || '{}');
    testResults.test1 = result;
    localStorage.setItem('testResults', JSON.stringify(testResults));

    // 서버에도 저장
    fetch('/save_result', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({test_name: 'test1', result: result})
    }).then(() => {
        playNextSound(); // 다음 영역 알림음
        setTimeout(() => {
            window.location.href = '/test2';
        }, 300);
    });
}
</script>
{% endblock %}
